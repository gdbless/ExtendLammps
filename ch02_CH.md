# Lampps 语法和源代码层次结构

在本章中，我们将概述 LAMMPS 输入脚本结构，并将脚本命令与后台运行的源代码连接起来。介绍了源代码存储库，然后是负责设置模拟框架和解析命令的类层次结构，最后简要概述了几个顶级类。

我们将涵盖以下主题：

- 介绍一个典型的 LAMMPS 输入脚本的结构

- 引入源代码文件的存储库

- 审查源代码层次结构

- 精选顶级类的功能

本章的最终目标是解释源代码如何布置仿真基础，这将帮助您更好地理解修改或扩展 LAMMPS 的过程。

＃＃ 技术要求
要执行本章中的指令，我们只需要一个文本编辑器（例如，Notepad++、Gedit）

你可以在这里找到本章使用的完整源代码：https://github.com/PacktPublishing/Extending-and-Modifying-LAMMPS-Writing-Your-Own-Source-Code。

##介绍LAMMPS输入脚本结构
LAMMPS 提供内置功能来使用自己的脚本语法构建 MD 模拟。LAMMPS 脚本语法清单可在 LAMMPS 网站 (www.lammps.sandia.gov) 上获得。输入脚本从头到尾逐行执行。一个典型的输入脚本由以下部分组成：

- 初始化设置

- 系统定义

- 模拟设置

- 模拟执行

示例输入脚本可能如下所示：

<div 对齐=居中>
<img src=./ch02/fig2_1.jpg>
</div>

图 2.1 – LAMMPS 的示例输入脚本

像这样的输入脚本通过指定模拟框大小和边界、创建原子、定义原子之间的电势对、应用恒温器并最终执行模拟来设置 MD 模拟。以“pair”开头的命令行定义了对电位，以“fix”开头的行在系统上执行多种操作，包括恒温器和时间积分。大量的 MD 特性是通过 `pair` 和 `fix` 命令实现的，这两个命令将在*第 5 章，了解配对样式和第 7 章，了解修复*中详细讨论。

在每一行，LAMMPS 可执行文件都会扫描命令脚本并执行相应的源代码。控制整个操作的源代码将在下一节中介绍。

## 引入源代码仓库
LAMMPS下载解压后（说明请访问https://lammps.sandia.gov/doc/Install_tarball.html），可以从src文件夹中访问源代码，如下图：

<div 对齐=居中>
<img src=./ch02/fig2_2.jpg>
</div>

图 2.2 – src 文件夹的屏幕截图，显示成对的 .cpp 和 .h 源文件，以及分成文件夹的包列表

源文件主要以成对的 C++ 和头文件的形式排列，分别扩展名为 .cpp 和 .h，它们共同负责在模拟中执行给定的角色。

编译 LAMMPS 可执行文件时，源文件以及任何可选包都会内置到其中。*图 2.2* 中所有大写字母标题的文件夹包含可选包，如果指定，可以将其构建到 LAMMPS 可执行文件中。一旦编译成功，可执行文件就能够识别 LAMMPS 输入脚本命令并调用已安装的相应源代码文件。

当执行 LAMMPS 脚本时，源代码中的顶级类首先实例化 LAMMPS，并通过分配内存、解析输入脚本行、分区处理器、实例化集成类和构建邻居列表来设置模拟。它允许执行输入脚本的其余部分，包括配对和修复命令，并通过打印屏幕输出来完成。下一节将讨论顶级类和源代码层次结构。

## 查看源代码层次结构
源代码层次结构中的最顶层类是 lammps.cpp（和 lammps.h），它通过容纳 LAMMPS 的实例来启动 LAMMPS。这样做时，lammps.cpp 分配可在整个代码中访问的基本类，如以下屏幕截图所示：

<div 对齐=居中>
<img src=./ch02/fig2_3.jpg>
</div>

图 2.3 – 来自 lammps.cpp 的代码片段

此实例化由 main.cpp 文件调用，该文件还将输入脚本传送到此 LAMMPS 实例以供后续执行，如以下屏幕截图所示：

<div 对齐=居中>
<img src=./ch02/fig2_4.jpg>
</div>

图 2.4 – main.cpp 中的代码片段

其余的模拟设置由其他几个顶级类执行，其中一些在此处简要描述：

- `memory.cpp`：创建和销毁多维数组
- `error.cpp`：打印错误和警告消息并中止模拟
- `universe.cpp`：创建和初始化分区以划分模拟域并将其分配给不同的内核
- `input.cpp`：在 LAMMPS 输入脚本中解析和执行命令
- `finish.cpp`：在模拟完成时将输出打印到屏幕上
- `atom.cpp` 和 `atom_vec.cpp`：存储和分配包含原子信息的数组，例如位置、力和分子索引
- `update.cpp`：实例化积分器；包含各种单位的物理常数并提供对时间步长的访问
- `neighbor.cpp`、`neigh_list.cpp` 和 `neigh_request.cpp`：为所有原子构建邻居列表和存储列表；允许在需要时调用特定类别的邻居列表
- `group.cpp`：将原子分配给组，并控制和计算这些组的属性
- `force.cpp`：设置平台以通过创建和验证对、键、角、二面角和更多类来计算键合力和非键合力
- `modify.cpp`：通过创建和验证修复和计算类列表来设置平台以应用修复和计算
- `output.cpp`：设置类和内存以将输出写入文件或显示在屏幕上

此外，还有称为“样式”的父类，其中包含大量子类（例如，“修复样式”、“配对样式”和“计算样式”）。这些父类及其子类在实现 MD 功能时最为相关，尤其是在调用这些类的 LAMMPS 脚本中的模拟设置和模拟执行阶段。

**重要的提示**：
有关源代码存储库和层次结构的更多信息，请参阅 https://lammps.sandia.gov/doc/。

虽然顶级类通常不需要为最终用户目的进行修改，但子样式类可以很容易地修改以实现自定义 MD 功能。这些类将在接下来的章节中详细讨论。


＃＃ 概括
本章介绍了 LAMMPS 源代码层次结构，以说明各种顶级类在设置仿真基础时所扮演的角色。此外，我们提到了在需要将自定义功能合并到 LAMMPS 中时更贴切的三种样式，我们将深入探讨这些样式。

下一章将引导您了解源代码文件的结构以及源代码在时间步的每次迭代中经历的执行阶段。

## 延伸阅读
- LAMMPS 开发人员指南 - 源文件和类拓扑：https://lammps.sandia.gov/doc/Developer_org.html

＃＃ 问题
1. src文件夹中，大写字母的文件夹包含哪些文件？
2. 哪个是源代码层次结构中最顶层的类？

------

# 第 2 节：
了解源代码结构

LAMMPS 源代码控制信息流并在 MD 模拟运行期间执行所需的计算。鉴于源代码的庞大范围，我们如何理解各个组件的功能？

在本节中，您将学习如何理解在执行 LAMMPS 命令时在后台运行的源代码的各个组件。重点放在在执行配对样式、计算和修复期间起作用的内部机制。

本节包括以下章节：

- 第 3 章，源代码结构和执行阶段

- 第 4 章，通过变量、数组和方法访问信息

- 第 5 章，了解配对样式

- 第 6 章，理解计算

- 第 7 章，了解修复

- 第 8 章，探索支持类
